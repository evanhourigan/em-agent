<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EM Agent - RAG Search</title>
    <style>
      body {
        font-family: -apple-system, system-ui, sans-serif;
        margin: 2rem;
      }
      .card {
        max-width: 720px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      button {
        padding: 10px 14px;
        border: none;
        background: #1f6feb;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
      }
      .result {
        border-top: 1px solid #eee;
        padding: 10px 0;
      }
      .meta {
        color: #555;
        font-size: 12px;
      }
      .score {
        color: #1a7f37;
        font-size: 12px;
      }
      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { text-align: left; padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; }
      .pill { display: inline-block; padding: 2px 8px; border-radius: 12px; background: #eee; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="card" style="margin-bottom: 16px">
      <h3>RAG Search</h3>
      <div class="row">
        <input id="q" type="text" placeholder="Search…" />
        <button onclick="doSearch()">Search</button>
      </div>
      <div id="results"></div>
    </div>
    <div class="card">
      <h3>Admin — Approvals & Jobs</h3>
      <div class="row" style="margin-bottom: 8px">
        <button onclick="loadApprovals()">Load Approvals</button>
        <button onclick="loadJobs()">Load Jobs</button>
      </div>
      <div class="row" style="margin-bottom: 8px">
        <input
          id="agent_q"
          type="text"
          placeholder="Agent query (e.g., sprint health)"
        />
        <button onclick="runAgent()">Run Agent</button>
      </div>
      <div id="approvals"></div>
      <div id="jobs" style="margin-top:12px"></div>
    </div>
    <script>
      async function doSearch() {
        const q = document.getElementById("q").value;
        const resp = await fetch("/search", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ q, top_k: 5 }),
        });
        const data = await resp.json();
        const list = document.getElementById("results");
        list.innerHTML = "";
        for (const r of data.results || []) {
          const el = document.createElement("div");
          el.className = "result";
          el.innerHTML = `<div class="meta">parent: ${r.parent_id || r.id} ${
            r.meta && r.meta.source ? "(" + r.meta.source + ")" : ""
          }</div><div>${
            r.snippet || r.content
          }</div><div class="score">score: ${r.score ?? ""}</div>`;
          list.appendChild(el);
        }
      }

      async function loadApprovals() {
        const resp = await fetch("http://localhost:8000/v1/approvals");
        const rows = await resp.json();
        const el = document.getElementById("approvals");
        if (!rows || rows.length === 0) { el.innerHTML = `<div>No approvals</div>`; return; }
        const body = rows.map(a => `
          <tr>
            <td>#${a.id}</td>
            <td>${a.subject}</td>
            <td>${a.action}</td>
            <td><span class="pill">${a.status}</span></td>
            <td style="white-space:nowrap">
              ${a.status === 'pending' ? `<button onclick="decide(${a.id}, 'approve')">Approve</button>
                <button style='background:#d93f0b' onclick="decide(${a.id}, 'decline')">Decline</button>` : ''}
            </td>
          </tr>`).join("");
        el.innerHTML = `<h4>Approvals</h4>
          <table>
            <thead><tr><th>ID</th><th>Subject</th><th>Action</th><th>Status</th><th></th></tr></thead>
            <tbody>${body}</tbody>
          </table>`;
      }

      async function loadJobs() {
        const resp = await fetch("http://localhost:8000/v1/workflows/jobs");
        const rows = await resp.json();
        const el = document.getElementById("jobs");
        if (!rows || rows.length === 0) { el.innerHTML = `<div>No jobs</div>`; return; }
        const body = rows.map(j => `
          <tr>
            <td>${j.id}</td>
            <td><span class="pill">${j.status}</span></td>
            <td>${j.rule_kind || ''}</td>
            <td>${j.subject || ''}</td>
          </tr>`).join("");
        el.innerHTML = `<h4>Jobs</h4>
          <table>
            <thead><tr><th>ID</th><th>Status</th><th>Rule</th><th>Subject</th></tr></thead>
            <tbody>${body}</tbody>
          </table>`;
      }

      async function runAgent() {
        const q = document.getElementById("agent_q").value;
        const resp = await fetch("http://localhost:8000/v1/agent/run", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ query: q }),
        });
        const data = await resp.json();
        const t = document.getElementById("approvals");
        t.innerHTML = `<h4>Agent Result</h4><pre>${JSON.stringify(data, null, 2)}</pre>`;
      }

      async function decide(id, decision) {
        await fetch(`http://localhost:8000/v1/approvals/${id}/decision`, {
          method: 'POST', headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ decision, reason: 'ui' }),
        });
        await loadApprovals();
        await loadJobs();
      }
    </script>
  </body>
</html>
