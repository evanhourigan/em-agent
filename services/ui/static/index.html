<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>EM Agent - RAG Search</title>
    <style>
      body {
        font-family: -apple-system, system-ui, sans-serif;
        margin: 2rem;
      }
      .card {
        max-width: 720px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 8px;
      }
      input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      button {
        padding: 10px 14px;
        border: none;
        background: #1f6feb;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
      }
      .result {
        border-top: 1px solid #eee;
        padding: 10px 0;
      }
      .meta {
        color: #555;
        font-size: 12px;
      }
      .score {
        color: #1a7f37;
        font-size: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      th,
      td {
        text-align: left;
        padding: 8px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        background: #eee;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="card" style="margin-bottom: 16px">
      <h3>RAG Search</h3>
      <div class="row">
        <input id="q" type="text" placeholder="Search…" />
        <button onclick="doSearch()">Search</button>
      </div>
      <div id="results"></div>
    </div>
    <div class="card">
      <h3>Admin — Approvals & Jobs</h3>
      <div class="row" style="margin-bottom: 8px">
        <button onclick="loadApprovals()">Load Approvals</button>
        <button onclick="loadJobs()">Load Jobs</button>
      </div>
      <div class="row" style="margin-bottom: 8px">
        <input
          id="agent_q"
          type="text"
          placeholder="Agent query (e.g., sprint health)"
        />
        <button onclick="runAgent()">Run Agent</button>
      </div>
      <div id="approvals"></div>
      <div id="jobs" style="margin-top: 12px"></div>
    </div>
    <div class="card" style="margin-top: 16px">
      <h3>Triage</h3>
      <div class="row" style="margin-bottom: 8px">
        <input id="stale_hours" type="text" placeholder="stale_pr hours (48)" />
        <input
          id="noreview_hours"
          type="text"
          placeholder="no_review hours (12)"
        />
        <button onclick="loadTriage()">Load Triage</button>
      </div>
      <div class="row" style="margin-bottom: 8px">
        <input
          id="triage_interval"
          type="text"
          placeholder="auto-refresh seconds (empty=off)"
        />
        <button onclick="startTriage()">Start Auto-Refresh</button>
        <button onclick="stopTriage()" style="background: #9a6700">Stop</button>
      </div>
      <div id="triage_stale"></div>
      <div id="triage_noreview" style="margin-top: 8px"></div>
    </div>
    <div class="card" style="margin-top: 16px">
      <h3>RAG — File Uploader</h3>
      <div class="row" style="margin-bottom: 8px">
        <input
          id="doc_id"
          type="text"
          placeholder="doc id (defaults to filename)"
        />
      </div>
      <input
        id="rag_file"
        type="file"
        accept=".txt,.md,.log,.json,.yaml,.yml"
      />
      <div style="margin-top: 8px">
        <button onclick="indexFile()">Index File</button>
      </div>
      <div id="upload_result" style="margin-top: 8px"></div>
    </div>
    <script>
      async function doSearch() {
        const q = document.getElementById("q").value;
        const resp = await fetch("/search", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ q, top_k: 5 }),
        });
        const data = await resp.json();
        const list = document.getElementById("results");
        list.innerHTML = "";
        for (const r of data.results || []) {
          const el = document.createElement("div");
          el.className = "result";
          const prov = r.provenance || {};
          const link = prov.url ? `<a href="${prov.url}" target="_blank">${prov.url}</a>` : "";
          const source = prov.source ? `(${prov.source})` : "";
          el.innerHTML = `<div class="meta">parent: ${r.parent_id || r.id} ${source} ${link}</div><div>${
            r.snippet || r.content
          }</div><div class="score">score: ${r.score ?? ""}</div>`;
          list.appendChild(el);
        }
      }

      async function loadApprovals() {
        const resp = await fetch("http://localhost:8000/v1/approvals");
        const rows = await resp.json();
        const el = document.getElementById("approvals");
        if (!rows || rows.length === 0) {
          el.innerHTML = `<div>No approvals</div>`;
          return;
        }
        const body = rows
          .map(
            (a) => `
          <tr>
            <td>#${a.id}</td>
            <td>${a.subject}</td>
            <td>${a.action}</td>
            <td><span class="pill">${a.status}</span></td>
            <td style="white-space:nowrap">
              ${
                a.status === "pending"
                  ? `<button onclick="decide(${a.id}, 'approve')">Approve</button>
                <button style='background:#d93f0b' onclick="decide(${a.id}, 'decline')">Decline</button>`
                  : ""
              }
            </td>
          </tr>`
          )
          .join("");
        el.innerHTML = `<h4>Approvals</h4>
          <table>
            <thead><tr><th>ID</th><th>Subject</th><th>Action</th><th>Status</th><th></th></tr></thead>
            <tbody>${body}</tbody>
          </table>`;
      }

      async function loadJobs() {
        const resp = await fetch("http://localhost:8000/v1/workflows/jobs");
        const rows = await resp.json();
        const el = document.getElementById("jobs");
        if (!rows || rows.length === 0) {
          el.innerHTML = `<div>No jobs</div>`;
          return;
        }
        const body = rows
          .map(
            (j) => `
          <tr>
            <td>${j.id}</td>
            <td><span class="pill">${j.status}</span></td>
            <td>${j.rule_kind || ""}</td>
            <td>${j.subject || ""}</td>
          </tr>`
          )
          .join("");
        el.innerHTML = `<h4>Jobs</h4>
          <table>
            <thead><tr><th>ID</th><th>Status</th><th>Rule</th><th>Subject</th></tr></thead>
            <tbody>${body}</tbody>
          </table>`;
      }

      async function runAgent() {
        const q = document.getElementById("agent_q").value;
        const resp = await fetch("http://localhost:8000/v1/agent/run", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ query: q }),
        });
        const data = await resp.json();
        const t = document.getElementById("approvals");
        t.innerHTML = `<h4>Agent Result</h4><pre>${JSON.stringify(
          data,
          null,
          2
        )}</pre>`;
      }

      async function decide(id, decision) {
        await fetch(`http://localhost:8000/v1/approvals/${id}/decision`, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ decision, reason: "ui" }),
        });
        await loadApprovals();
        await loadJobs();
      }

      let triageTimer = null;
      async function loadTriage() {
        const staleH = parseInt(
          document.getElementById("stale_hours").value || "48",
          10
        );
        const noRevH = parseInt(
          document.getElementById("noreview_hours").value || "12",
          10
        );
        const resp = await fetch("http://localhost:8000/v1/signals/evaluate", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            rules: [
              { name: "stale", kind: "stale_pr", older_than_hours: staleH },
              {
                name: "no_review",
                kind: "pr_without_review",
                older_than_hours: noRevH,
              },
            ],
          }),
        });
        const data = await resp.json();
        const stale = (data.results && data.results.stale) || [];
        const noReview = (data.results && data.results.no_review) || [];
        const staleBody = stale
          .map(
            (r) =>
              `<tr><td>${r.delivery_id || ""}</td><td>${
                r.opened_at || ""
              }</td></tr>`
          )
          .join("");
        const noRevBody = noReview
          .map(
            (r) =>
              `<tr><td>${r.delivery_id || ""}</td><td>${
                r.opened_at || ""
              }</td></tr>`
          )
          .join("");
        document.getElementById("triage_stale").innerHTML = `
          <h4>Stale PRs (${stale.length})</h4>
          <table><thead><tr><th>PR</th><th>Opened</th></tr></thead><tbody>${staleBody}</tbody></table>`;
        document.getElementById("triage_noreview").innerHTML = `
          <h4>PRs Without Review (${noReview.length})</h4>
          <table><thead><tr><th>PR</th><th>Opened</th></tr></thead><tbody>${noRevBody}</tbody></table>`;
      }

      function startTriage() {
        const sec = parseInt(
          document.getElementById("triage_interval").value || "0",
          10
        );
        if (!sec || sec <= 0) return;
        if (triageTimer) clearInterval(triageTimer);
        triageTimer = setInterval(loadTriage, sec * 1000);
        loadTriage();
      }

      function stopTriage() {
        if (triageTimer) clearInterval(triageTimer);
        triageTimer = null;
      }

      async function indexFile() {
        const fileInput = document.getElementById("rag_file");
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          document.getElementById("upload_result").innerText =
            "No file selected";
          return;
        }
        const reader = new FileReader();
        reader.onload = async () => {
          const content = reader.result;
          const id = document.getElementById("doc_id").value || file.name;
          const resp = await fetch("/index", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ id, content, meta: { source: file.name } }),
          });
          const data = await resp.json();
          document.getElementById(
            "upload_result"
          ).innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        };
        reader.readAsText(file);
      }
    </script>
  </body>
</html>
